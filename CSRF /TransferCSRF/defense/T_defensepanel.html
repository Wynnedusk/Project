<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSRF Transfer - Defense Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#2563eb;--blue-d:#1d4ed8;--bg:#f4f6fa;--card:#fff;--border:#e5e7eb;--muted:#64748b;--ink:#0f172a;--ok:#16a34a;--bad:#b91c1c}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;padding:30px;background:var(--bg);color:var(--ink);text-align:center}
    h1{margin:0 0 16px}
    .topbar{display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:18px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#f8fafc;border-radius:8px;cursor:pointer}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue-d);font-weight:600}
    .badge{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:600}
    .s-ok{color:var(--ok)} .s-bad{color:var(--bad)}
    .container{display:flex;gap:30px;justify-content:center;align-items:flex-start}
    .panel{border:1px solid var(--border);background:var(--card);padding:10px;width:600px;height:600px;border-radius:12px;display:flex;flex-direction:column}
    .panel h2{margin:0 0 8px;font-size:18px}
    .frameWrap{flex:1;min-height:0;overflow:auto}
    .frameWrap>iframe{width:100%;height:100%;border:none;border-radius:6px;background:#fff}
    .reload-btn{margin-top:10px}
    .teach{max-width:1230px;margin:20px auto 0;display:flex;flex-direction:column;gap:14px;text-align:left}
    .teachbox{border:1px solid var(--border);border-radius:10px;background:#fff;overflow:hidden}
    .teachbox>summary{padding:12px 14px;list-style:none;font-weight:700;cursor:pointer;background:#f8fafc;border-bottom:1px solid var(--border)}
    .teachbox>summary::-webkit-details-marker{display:none}
    .teachbox[open]>summary{background:#eef2ff}
    .teachbox .box{padding:12px 14px}
    code,pre{background:#0f172a;color:#e5e7eb;border-radius:8px;padding:10px;display:block;overflow:auto}
    .muted{color:var(--muted);font-size:13px}
  </style>

  <!-- Intro.js is used only to highlight steps (do not alter the guide copy unless fixing typos) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>
</head>
<body>
  <h1>CSRF Transfer - Defense Panel</h1>

  <div class="topbar">
    <button class="btn" onclick="doReset()">Reset Demo</button>
    <button class="btn btn-primary" onclick="startGuide()">Start Guide</button>
    <span class="badge">Status: <span id="statusText" class="s-ok">Idle</span></span>
  </div>

  <div class="container">
    <!-- Left: Victim -->
    <div class="panel" id="victimPanel">
      <h2>Login (Defended)</h2>
      <div class="frameWrap">
        <!-- Boot: always start from login; then remember last page (login or home) -->
        <iframe id="victimFrame" name="victimFrame" src="about:blank" title="Victim"></iframe>
      </div>
      <button class="reload-btn btn" onclick="reloadCurrentVictim()">Reload Current Page</button>
    </div>

    <!-- Right: Attacker -->
    <div class="panel" id="attackerPanel">
      <h2>Attacker Attempt</h2>
      <div class="frameWrap">
        <iframe id="attackerFrame" name="attackerFrame" src="phishing-link-defense.html" title="Attacker"></iframe>
      </div>
      <button class="reload-btn btn" onclick="reloadAttacker()">Reload Attacker</button>
    </div>
  </div>

  <!-- Teaching area (collapsed by default) -->
  <div class="teach">
    <details class="teachbox">
      <summary>What just happened?</summary>
      <div class="box">
        <p>
          You clicked the red button. The fake page tried a POST transfer <b>without</b> our CSRF token.
          The server rejected it, so no debit appeared and the status stayed <b>Protected</b>.
        </p>
      </div>
    </details>

    <details class="teachbox">
      <summary>Why was the transfer blocked?</summary>
      <div class="box">
        <ul style="margin:0 0 0 18px;">
          <li>Real transfer form carries a hidden token.</li>
          <li>Server compares the form token with the browser’s token.</li>
          <li>Phishing pages can’t read/forward that token → request refused.</li>
        </ul>
      </div>
    </details>

    <details class="teachbox">
      <summary>View key defense code</summary>
      <div class="box">
        <p><b>1) Issue a CSRF token after login</b></p>
<pre><code>// login.php (after successful login)
session_start();
if (empty($_COOKIE['csrf_token'])) {
  setcookie('csrf_token', bin2hex(random_bytes(32)), [
    'secure' => true, 'samesite' => 'Lax', 'path' => '/'
  ]);
}
</code></pre>

        <p><b>2) Real transfer page sends the token back</b></p>
<pre><code>&lt;!-- secure-home.html --&gt;
&lt;input type="hidden" name="csrf_token" id="csrf_token"&gt;
&lt;script&gt;
  const m = document.cookie.match(/(?:^|; )csrf_token=([^;]+)/);
  document.getElementById('csrf_token').value = m ? decodeURIComponent(m[1]) : '';
&lt;/script&gt;
</code></pre>

        <p><b>3) Server verifies before moving money</b></p>
<pre><code>// defense/secure-pay.php
$tf = $_POST['csrf_token']  ?? '';
$tc = $_COOKIE['csrf_token']?? '';
if (!hash_equals($tc, $tf)) {
  http_response_code(403); exit('Invalid CSRF token');
}
// token OK: continue the transfer...
</code></pre>
      </div>
    </details>
  </div>

<script>
  // ====== elements ======
  const statusEl      = document.getElementById('statusText');
  const victimFrame   = document.getElementById('victimFrame');
  const attackerFrame = document.getElementById('attackerFrame');

  // Only adjust the refresh mechanism: remember the last page on the left; first load = login; Reset returns to login
  const STORE_KEY = 'def_victim_last_url';

  function setStatusProtected(on){
    statusEl.textContent = on ? 'Protected' : 'Idle';
    statusEl.classList.remove('s-bad');
    statusEl.classList.add('s-ok');
  }

  // Boot: restore the saved page if present; otherwise go to login
  function bootVictim(){
    const saved = sessionStorage.getItem(STORE_KEY);
    victimFrame.src = saved || '../server/login.html';
  }

  // After each navigation, record the final URL (login or home)
  victimFrame.addEventListener('load', ()=>{
    try{
      const href = victimFrame.contentWindow.location.href;
      if(href && href !== 'about:blank'){
        sessionStorage.setItem(STORE_KEY, href);
      }
    }catch(e){}
  });

  // Reload the current page only (keep login/home)
  function reloadCurrentVictim(){
    try{
      const href = victimFrame.contentWindow?.location?.href || victimFrame.src;
      const u = new URL(href, location.href);
      u.searchParams.set('_v', Date.now());
      victimFrame.src = u.toString();
    }catch(e){
      const u = new URL(victimFrame.src, location.href);
      u.searchParams.set('_v', Date.now());
      victimFrame.src = u.toString();
    }
  }

  function reloadAttacker(){
    const u = new URL(attackerFrame.src, location.href);
    u.searchParams.set('_v', Date.now());
    attackerFrame.src = u.toString();
  }

  // Reset: clear server state + clear memory → back to login
  function doReset(){
    fetch('../server/reset.php', { method:'POST', cache:'no-store' })
      .catch(()=>{})
      .finally(()=>{
        sessionStorage.removeItem(STORE_KEY);
        setStatusProtected(false);
        victimFrame.src = '../server/login.html';
        reloadAttacker();
      });
  }

  // Receive "defense succeeded" notification from token.html (keep behavior unchanged)
  window.addEventListener('message', (e)=>{
    const d = e.data || {};
    if(d.type === 'DEFENDED'){
      setStatusProtected(true);
      // If you want to refresh logs immediately, enable the next line:
      // reloadCurrentVictim();
    }
  }, false);

  // ====== Start Guide (keep your original guide intent; only fix typos/grammar) ======
  function startGuide() {
    introJs().setOptions({
      nextLabel: 'Next', prevLabel: 'Back', doneLabel: 'Done',
      exitOnOverlayClick: false, scrollToElement: true,
      steps: [
        { element: '#victimPanel',   intro: 'Step 1: In the left panel, log in to the account.' },
        { element: '#attackerPanel', intro: 'Step 2: In the right panel, click the phishing link to trigger a forged transfer.' },
        { element: '#victimPanel',   intro: 'Step 3: Watch the status turn <b>Protected</b>. Refresh the panel—no debit appears because the token defense intercepts the request.' },
        { element: '.teach',         intro: 'Step 4: After the demo, review this teaching section for clear explanations below.' }
      ]
    }).start();
  }

  // Boot
  bootVictim();
  setStatusProtected(false);
</script>
</body>
</html>
