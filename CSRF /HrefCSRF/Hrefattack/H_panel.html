<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GET CSRF Demo — Href Attack Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --blue:#2563eb; --blue-d:#1d4ed8;
      --bg:#f4f6fa; --card:#fff; --border:#e5e7eb; --muted:#64748b; --ink:#0f172a;
      --ok:#16a34a; --bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      margin:0; padding:30px; background:var(--bg); color:var(--ink); text-align:center;
    }
    h1{margin:0 0 16px}
    .topbar{display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:18px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#f8fafc;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--blue);color:#fff;border-color:var(--blue-d);font-weight:600}
    .badge{padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:600}
    .s-ok{color:var(--ok)}
    .s-bad{color:var(--bad)}
    .container{display:flex;gap:30px;justify-content:center;align-items:flex-start}
    .panel{
      border:1px solid var(--border); background:var(--card);
      padding:10px; width:600px; height:600px; border-radius:12px;
      display:flex; flex-direction:column;
    }
    .panel h2{margin:0 0 8px; font-size:18px}
    .frameWrap{flex:1; min-height:0; overflow:auto}
    .frameWrap>iframe{width:100%; height:100%; border:none; border-radius:6px; background:#fff}
    .reload-btn{margin-top:10px}

    /* Teaching prompts */
    .teach{max-width:1230px;margin:20px auto 0;display:flex;flex-direction:column;gap:14px;text-align:left}
    .teachbox{
      border:1px solid var(--border); border-radius:10px; background:#fff; overflow:hidden;
    }
    .teachbox>summary{
      padding:12px 14px; list-style:none; font-weight:700; cursor:pointer; background:#f8fafc;
      border-bottom:1px solid var(--border)
    }
    .teachbox>summary::-webkit-details-marker{display:none}
    .teachbox[open]>summary{background:#eef2ff}
    .teachbox .box{padding:12px 14px}

    /* 修复：只有 <pre> 是黑底代码块；行内 <code> 采用浅灰小胶囊 */
    pre{
      background:#0f172a; color:#e5e7eb; border-radius:8px; padding:10px; overflow:auto;
      margin:0;
    }
    code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      background:#f1f5f9; color:#0f172a; border-radius:4px; padding:0 6px;
    }
    .muted{color:var(--muted); font-size:13px}
  </style>

  <!-- Intro.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>
</head>
<body>
  <h1>GET CSRF Demo — Href Attack</h1>

  <div class="topbar">
    <button class="btn" onclick="doReset()">Reset Demo</button>
    <button class="btn btn-primary" onclick="startGuide()">Start Guide</button>
    <span class="badge">Status: <span id="statusText" class="s-ok">Idle</span></span>
  </div>

  <div class="container">
    <!-- Victim / Profile -->
    <div class="panel" id="victimPanel">
      <h2>Profile (Victim)</h2>
      <div class="frameWrap">
        <!-- 必须带 name="victimFrame"，攻击页的 a/target 会用到 -->
        <iframe id="victimFrame" name="victimFrame" src="H_profile.php?step=1" title="Victim Profile"></iframe>
      </div>
      <button class="reload-btn btn" onclick="reloadVictim()">Reload Victim</button>
    </div>

    <!-- Attacker -->
    <div class="panel" id="attackerPanel">
      <h2>Attacker Attempt</h2>
      <div class="frameWrap">
        <iframe id="attackerFrame" src="H_attacker.html" title="Attacker Page"></iframe>
      </div>
      <button class="reload-btn btn" onclick="reloadAttacker()">Reload Attacker</button>
    </div>
  </div>

  <!-- Teaching area -->
  <div class="teach" id="teachingSection">
    <!-- What just happened -->
    <details class="teachbox" >
      <summary>What just happened?</summary>
      <div class="box">
        <p>
          A normal-looking link on the attacker’s page made your browser load a URL
          on the real site <i>inside the left iframe</i>. Because you were logged in,
          your <b>session cookie</b> went with the request automatically. The server
          wrongly treats that URL as “follow this user”, so your account followed
          the attacker without your intention.
        </p>
      </div>
    </details>

    <!-- Why did the attack succeed? -->
    <details class="teachbox" >
      <summary>Why did the attack succeed?</summary>
      <div class="box">
        <ol style="margin:0 0 0 20px">
          <li><b>Unsafe design:</b> the site lets a simple <code>GET</code> link perform a
              change (follow someone). Data changes should not be done by plain links.</li>
          <li><b>Automatic cookies:</b> when the browser loads that URL, it attaches your
              <b>login cookie</b>, so the request looks like it came from you.</li>
          <li><b>No CSRF token:</b> there is no secret token that only the real page can send,
              so any page can trigger the action.</li>
          <li><b>No origin checks:</b> the server doesn’t verify <code>Origin/Referer</code>,
              so it can’t tell the request came from the attacker’s page.</li>
          <li><b>Hidden in an iframe:</b> the attacker targets the left profile frame, so the
              change happens quietly and looks legitimate.</li>
        </ol>
        <p class="muted" style="margin-top:10px">
          In short: a plain link caused a cross-site “follow” because cookies made it look like you,
          and the server had no CSRF or origin validation to stop it.
        </p>
      </div>
    </details>

    <!-- Vulnerable handler -->
    <details class="teachbox">
      <summary>View vulnerable handler snippet</summary>
      <div class="box">
<pre><code>// H_follower.php (core logic, vulnerable)
require_once __DIR__ . '/Hsession.php';

if (empty($_SESSION['i_loggedIn'])) { http_response_code(401); exit('Not logged in'); }

// reads who to follow from the URL (GET)
$user = trim($_GET['user'] ?? '');

// state change via GET; no CSRF token, no Origin/Referer checks
if ($user !== '') {
  $_SESSION['i_follows'][] = $user;
  $_SESSION['i_attacked'] = true; // demo flag
  header('Location: H_profile.php?added=1&new=' . urlencode($user));
  exit;
}
</code></pre>
        <ul class="muted" style="margin-top:10px; margin-left:18px;">
          <li><b>Problem 1:</b> Changes server data via <code>GET</code>.</li>
          <li><b>Problem 2:</b> Trusts any request carrying your cookie (no CSRF token).</li>
          <li><b>Problem 3:</b> No <code>Origin/Referer</code> validation.</li>
        </ul>
      </div>
    </details>
  </div>

<script>
  // ---- Elements
  const victimFrame   = document.getElementById('victimFrame');
  const attackerFrame = document.getElementById('attackerFrame');
  const statusEl      = document.getElementById('statusText');

  function setStatus(attacked){
    if(attacked){
      statusEl.textContent = 'Attacked';
      statusEl.classList.remove('s-ok'); statusEl.classList.add('s-bad');
    }else{
      statusEl.textContent = 'Idle';
      statusEl.classList.remove('s-bad'); statusEl.classList.add('s-ok');
    }
  }

  function reloadVictim(){
    const u=new URL(victimFrame.src,location.href);
    u.searchParams.set('_v',Date.now());
    victimFrame.src=u.toString();
  }
  function reloadAttacker(){
    const u=new URL(attackerFrame.src,location.href);
    u.searchParams.set('_v',Date.now());
    attackerFrame.src=u.toString();
  }

  function doReset(){
    fetch('H_profile.php?reset=1',{method:'POST',cache:'no-store'})
      .catch(()=>{})
      .finally(()=>{
        setStatus(false);
        reloadVictim();
        reloadAttacker();
      });
  }

  let pollTimer=null;
  function checkVictimState(){
    return fetch('H_profile.php?state=1',{cache:'no-store'})
      .then(r=>r.ok?r.json():Promise.reject())
      .then(s=>{
        const attacked = !!(s && s.attacked);
        if(attacked){
          clearInterval(pollTimer); pollTimer=null;
          setStatus(true);
          reloadVictim();
        }
      }).catch(()=>{});
  }

  // 由攻击页通知“开始攻击”后，轮询受害者状态
  window.addEventListener('message',(e)=>{
    const d = e.data || {};
    if(d.type === 'ATTACK_FIRED'){
      if(pollTimer) clearInterval(pollTimer);
      let n=0;
      pollTimer = setInterval(()=>{
        checkVictimState();
        if(++n>20){ clearInterval(pollTimer); pollTimer=null; }
      }, 300);
    }
  }, false);

  // Intro 教学引导（新增 Step 4 指向教学提示区域）
  function startGuide(){
    introJs().setOptions({
      nextLabel:'Next', prevLabel:'Back', doneLabel:'Done',
      exitOnOverlayClick:false, scrollToElement:true,
      steps:[
        { element:'#victimPanel',   intro:'Step 1: In the left profile, use “Simulate Login” so the session is active.' },
        { element:'#attackerPanel', intro:'Step 2: In the right attacker panel, click “View more photos”.' },
        { element:'#victimPanel',   intro:'Step 3: The left profile changes and the status flips to Attacked.' },
        { element:'#teachingSection', intro:'Step 4: After the demo, check this teaching section for clear explanations below.' }
      ]
    }).start();
  }

  setStatus(false);
</script>
</body>
</html>
